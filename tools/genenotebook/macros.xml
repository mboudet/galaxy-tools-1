<?xml version="1.0"?>
<macros>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">genenotebook</requirement>
            <yield/>
        </requirements>
    </xml>

    <token name="@TOOL_VERSION@">0.1.16</token>
    <token name="@WRAPPER_VERSION@">@TOOL_VERSION@+galaxy0</token>
    <token name="@MONGODB_VERSION@">5.0.0</token>

    <xml name="citation">
        <citations>
            <citation type="doi">10.1093/bioinformatics/btz491</citation>
        </citations>
    </xml>

    <!--
    This runs GeneNoteBook, and a local mongodb server listening only on a unix socket, created in the work dir.
    The bind_ip option is a trick to prevent mongod from opening a TCP socket.
    For some unknwon reason, unixSocketPrefix needs an absolute path
    -->
    <token name="@START_GNB@"><![CDATA[
        export GNB_PORT=\$(bash $__tool_directory__/find_free_port.sh);
        export MONGO_URI=\$(pwd | sed 's|/|%2F|g');
        #if $existing
            tar -xf '${existing}' mongo_db &&
        #else
            mkdir ./mongo_db/ &&
        #end if
        mongod --dbpath ./mongo_db/ --unixSocketPrefix `pwd` --bind_ip fake_socket --logpath ./mongod.log --pidfilepath ./mongo.pid & true &&
        sleep 5;
        ## GNB_PID gets wrong value when using && here
        genenotebook run --port \${GNB_PORT} --mongo-url mongodb://\$MONGO_URI%2Fmongodb-27017.sock/genenotebook & GNB_PID=\$! &&
        sleep 15 &&
    ]]></token>

    <token name="@ZIP_GNB@"><![CDATA[
        &&
        ##cat ./mongod.log 1>&2 &&
        ## Kill GeneNoteBook
        kill \$GNB_PID &&
        ## Kill MongoDB
        sleep 5 &&
        kill \$(<"./mongo.pid") &&
        sleep 5 &&
        ## Zip the mongodb data dir
        tar -cvjf '${gnb_db}' mongo_db > /dev/null

        ## Make sure mongodb and GNB are really really stopped even if anything failed before
        ;
        kill \$GNB_PID &> /dev/null || true
        ;
        kill \$(<"./mongo.pid") &> /dev/null || true
    ]]></token>
</macros>
